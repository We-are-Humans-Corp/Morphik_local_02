# EXPERIMENTAL VERSION - использует общую инфраструктуру
version: '3.8'

services:
  morphik_experimental:
    build: ./Morphik_experimental
    container_name: morphik_experimental_api
    ports:
      - "8001:8000"  # Порт 8001 чтобы не конфликтовать со stable
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      - POSTGRES_URI=postgresql+asyncpg://morphik:morphik@morphik_postgres_shared:5432/morphik_experimental
      - REDIS_HOST=morphik_redis_shared
      - REDIS_PORT=6379
      - HOST=0.0.0.0
      - PORT=8000
    volumes:
      - ./Morphik_experimental/storage:/app/storage
      - ./Morphik_experimental/logs:/app/logs
      - ./Morphik_experimental/morphik.toml:/app/morphik.toml
    networks:
      - morphik_shared_network
    depends_on:
      - worker_experimental

  worker_experimental:
    build: ./Morphik_experimental
    container_name: morphik_experimental_worker
    command: arq core.workers.ingestion_worker.WorkerSettings
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      - POSTGRES_URI=postgresql+asyncpg://morphik:morphik@morphik_postgres_shared:5432/morphik_experimental
      - REDIS_HOST=morphik_redis_shared
      - REDIS_PORT=6379
    volumes:
      - ./Morphik_experimental/storage:/app/storage
      - ./Morphik_experimental/logs:/app/logs
      - ./Morphik_experimental/morphik.toml:/app/morphik.toml
    networks:
      - morphik_shared_network

  ui_experimental:
    build:
      context: ./Morphik_experimental/ee/ui-component
      dockerfile: Dockerfile
    container_name: morphik_experimental_ui
    ports:
      - "3001:3000"  # Порт 3001 чтобы не конфликтовать со stable
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8001
      - INTERNAL_API_URL=http://morphik_experimental:8000
      - NODE_ENV=production
    networks:
      - morphik_shared_network

networks:
  morphik_shared_network:
    external: true