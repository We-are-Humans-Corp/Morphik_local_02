# STABLE VERSION - использует общую инфраструктуру
version: '3.8'

services:
  morphik_stable:
    build: ./Morphik_local
    container_name: morphik_stable_api
    ports:
      - "8000:8000"
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      - POSTGRES_URI=postgresql+asyncpg://morphik:morphik@morphik_postgres_shared:5432/morphik_stable
      - REDIS_HOST=morphik_redis_shared
      - REDIS_PORT=6379
      - HOST=0.0.0.0
      - PORT=8000
    volumes:
      - ./Morphik_local/storage:/app/storage
      - ./Morphik_local/logs:/app/logs
      - ./Morphik_local/morphik.toml:/app/morphik.toml
    networks:
      - morphik_shared_network
    depends_on:
      - worker_stable

  worker_stable:
    build: ./Morphik_local
    container_name: morphik_stable_worker
    command: arq core.workers.ingestion_worker.WorkerSettings
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      - POSTGRES_URI=postgresql+asyncpg://morphik:morphik@morphik_postgres_shared:5432/morphik_stable
      - REDIS_HOST=morphik_redis_shared
      - REDIS_PORT=6379
    volumes:
      - ./Morphik_local/storage:/app/storage
      - ./Morphik_local/logs:/app/logs
      - ./Morphik_local/morphik.toml:/app/morphik.toml
    networks:
      - morphik_shared_network

  ui_stable:
    build:
      context: ./Morphik_local/ee/ui-component
      dockerfile: Dockerfile
    container_name: morphik_stable_ui
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - INTERNAL_API_URL=http://morphik_stable:8000
      - NODE_ENV=production
    networks:
      - morphik_shared_network

networks:
  morphik_shared_network:
    external: true