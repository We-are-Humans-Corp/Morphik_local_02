#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ API —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
# API —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î –∏ —Å–µ—Ä–≤–∏—Å—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ 135.181.106.12

echo "üöÄ –ó–∞–ø—É—Å–∫ Morphik API –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
echo "üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É: 135.181.106.12"

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f .env.server ]; then
    export $(cat .env.server | grep -v '^#' | xargs)
fi

# –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
export DATABASE_URL="postgresql://morphik:morphik@135.181.106.12:5432/morphik"
export REDIS_URL="redis://135.181.106.12:6379"
export OLLAMA_BASE_URL="http://135.181.106.12:11434"

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "   - API (–ª–æ–∫–∞–ª—å–Ω–æ): http://localhost:8001"
echo "   - PostgreSQL (—Å–µ—Ä–≤–µ—Ä): 135.181.106.12:5432"
echo "   - Redis (—Å–µ—Ä–≤–µ—Ä): 135.181.106.12:6379"
echo "   - Ollama (—Å–µ—Ä–≤–µ—Ä): 135.181.106.12:11434"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
docker run --rm postgres:15 psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ API —á–µ—Ä–µ–∑ docker-compose
echo ""
echo "üîÑ –ó–∞–ø—É—Å–∫ API —Å hot reload..."
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

docker-compose -f docker-compose.dev.yml --env-file .env.server up morphik-dev